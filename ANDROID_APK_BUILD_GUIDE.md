# Android APK Generation Guide

This guide explains how to build Android APK files for BizHawk Rafaelia.

## Quick Start

### Automated Build (Recommended)

```bash
# From repository root
./Dist/BuildAndroidAPK.sh

# For debug build
./Dist/BuildAndroidAPK.sh --debug

# Clean build
./Dist/BuildAndroidAPK.sh --clean
```

### Manual Build

```bash
# Navigate to repository root
cd /path/to/BizHawkRafaelia

# Build Release APK
dotnet publish src/BizHawk.Client.Android/BizHawk.Client.Android.csproj \
  -c Release \
  -f net8.0-android \
  -o ./apk-output

# Build Debug APK
dotnet build src/BizHawk.Client.Android/BizHawk.Client.Android.csproj \
  -c Debug \
  -f net8.0-android
```

## Prerequisites

### Required Software

1. **.NET SDK 8.0 or higher**
   ```bash
   # Install from https://dotnet.microsoft.com/download
   dotnet --version
   ```

2. **Android Workload**
   ```bash
   dotnet workload install android
   dotnet workload list
   ```

3. **Java Development Kit (JDK) 11 or higher**
   ```bash
   # Verify installation
   java -version
   ```

4. **Android SDK and NDK** (automatically installed with Android workload)

### Optional Tools

- **Android Studio**: For emulator testing and debugging
- **ADB (Android Debug Bridge)**: For device installation and debugging

## GitHub Actions Workflow

APK builds are automatically generated by GitHub Actions on:

- Push to `master`, `develop`, or `copilot/**` branches
- Pull requests to `master` or `develop`
- Manual workflow dispatch

### Downloading APKs from GitHub Actions

1. Go to the repository's Actions tab
2. Click on the latest "Build Android APK" workflow run
3. Download artifacts:
   - `BizHawk-Android-Debug-APK` - Debug version
   - `BizHawk-Android-Release-APK` - Release version (recommended)
   - `APK-Build-Summary` - Build information

## APK Types

### Debug APK
- **Purpose**: Development and testing
- **Size**: Larger (~50-100 MB)
- **Performance**: Not optimized
- **Signing**: Debug keystore (auto-generated)
- **Location**: `src/BizHawk.Client.Android/bin/Debug/net8.0-android/`

### Release APK
- **Purpose**: Distribution and production use
- **Size**: Smaller (~30-60 MB)
- **Performance**: Optimized with R8 and trimming
- **Signing**: Requires keystore (unsigned by default)
- **Location**: `apk-output/` or `src/BizHawk.Client.Android/bin/Release/net8.0-android/`

### Per-ABI APKs

Release builds generate separate APKs for each architecture:
- `com.bizhawkrafaelia.emulator-arm64-v8a.apk` - ARM64 (most Android devices)
- `com.bizhawkrafaelia.emulator-x86_64.apk` - x86_64 (emulators, some tablets)

This reduces APK size by 30-50% per architecture.

## Signing APKs

### For Development
Debug APKs are automatically signed with a debug keystore.

### For Production

1. **Generate a keystore** (one-time):
   ```bash
   keytool -genkeypair -v \
     -keystore bizhawk-release.keystore \
     -alias bizhawk \
     -keyalg RSA -keysize 2048 \
     -validity 10000
   ```

2. **Build signed APK**:
   ```bash
   dotnet publish src/BizHawk.Client.Android/BizHawk.Client.Android.csproj \
     -c Release \
     -f net8.0-android \
     -p:AndroidSigningKeyStore=/path/to/bizhawk-release.keystore \
     -p:AndroidSigningKeyAlias=bizhawk \
     -p:AndroidSigningKeyPass=your_key_password \
     -p:AndroidSigningStorePass=your_store_password \
     -o ./apk-output
   ```

3. **Verify signature**:
   ```bash
   jarsigner -verify -verbose -certs your-app.apk
   ```

## Installation

### Via ADB (USB Debugging)

1. Enable Developer Mode on Android device:
   - Go to Settings > About Phone
   - Tap "Build Number" 7 times

2. Enable USB Debugging:
   - Go to Settings > Developer Options
   - Enable "USB Debugging"

3. Connect device and install:
   ```bash
   # Install new APK
   adb install path/to/app.apk
   
   # Reinstall (update existing app)
   adb install -r path/to/app.apk
   
   # Verify installation
   adb shell pm list packages | grep bizhawk
   ```

### Manual Installation

1. Transfer APK to device (USB, cloud, email, etc.)
2. Open file manager on device
3. Tap the APK file
4. Allow installation from unknown sources if prompted
5. Follow installation prompts

### Google Play Store (Future)

For public distribution, APKs need to be:
1. Signed with a production keystore
2. Converted to AAB (Android App Bundle) format
3. Uploaded to Google Play Console
4. Reviewed and published

## Testing

### Using Android Emulator

1. Start emulator:
   ```bash
   # List available emulators
   emulator -list-avds
   
   # Start specific emulator
   emulator -avd Pixel_5_API_33
   ```

2. Install APK:
   ```bash
   adb -e install path/to/app.apk
   ```

3. Launch app:
   ```bash
   adb shell am start -n com.bizhawkrafaelia.emulator/.MainActivity
   ```

### Using Real Device

1. Connect device via USB
2. Install APK using ADB
3. Launch app from launcher or via ADB

### Viewing Logs

```bash
# View all logs
adb logcat

# Filter BizHawk logs
adb logcat | grep BizHawk

# Clear log buffer
adb logcat -c

# Save logs to file
adb logcat > bizhawk-logs.txt
```

## Troubleshooting

### Android Workload Not Found

```bash
# Reinstall Android workload
dotnet workload install android --skip-manifest-update

# If still failing, update .NET SDK
dotnet --version
# Download latest from https://dotnet.microsoft.com/download
```

### Build Errors

1. **"Android SDK not found"**
   ```bash
   # Set ANDROID_SDK_ROOT environment variable
   export ANDROID_SDK_ROOT=$HOME/Android/Sdk
   ```

2. **"Java runtime not found"**
   ```bash
   # Install JDK 11 or higher
   # Ubuntu/Debian:
   sudo apt install openjdk-17-jdk
   
   # macOS:
   brew install openjdk@17
   ```

3. **"Out of memory" during build**
   ```bash
   # Increase Java heap size
   export JAVA_OPTS="-Xmx4g"
   ```

### Installation Errors

1. **"App not installed"**
   - Ensure USB debugging is enabled
   - Try uninstalling previous version first
   - Check device storage space

2. **"Parse error"**
   - APK may be corrupted, rebuild
   - Architecture mismatch (x86 APK on ARM device)

3. **"Installation blocked"**
   - Enable "Install from unknown sources"
   - Check if Google Play Protect is blocking

## APK Size Optimization

Current optimizations in Release builds:

1. **Code Trimming**: Removes unused code
   - Configured via `PublishTrimmed=true`
   - Reduces size by 30-50%

2. **Per-ABI Splits**: Separate APKs per architecture
   - Configured via `AndroidCreatePackagePerAbi=true`
   - Reduces size by 40-60%

3. **R8 Optimization**: Android bytecode optimization
   - Configured via `AndroidEnableProguard=true`
   - Reduces size by 10-20%

4. **Link SDK Only**: Links only SDK assemblies
   - Configured via `AndroidLinkMode=SdkOnly`
   - Prevents issues with emulation cores

### Expected APK Sizes

| Configuration | Size Range |
|---------------|------------|
| Debug (universal) | 80-120 MB |
| Release (universal) | 40-80 MB |
| Release (per-ABI) | 20-40 MB |
| Release (optimized) | 15-30 MB |

## Performance Considerations

### Device Requirements

**Minimum**:
- Android 5.0 (API 21)
- ARM64 processor
- 2GB RAM
- OpenGL ES 2.0

**Recommended**:
- Android 8.0 (API 26) or higher
- Snapdragon 660 or equivalent
- 4GB+ RAM
- 2GB free storage

### Emulation Performance

Expected FPS for popular systems:

| System | Low-end | Mid-range | High-end |
|--------|---------|-----------|----------|
| NES | 60 | 60 | 60 |
| SNES | 40-50 | 60 | 60 |
| Game Boy | 60 | 60 | 60 |
| GBA | 50-60 | 60 | 60 |
| N64 | 20-30 | 40-50 | 60 |
| PS1 | 30-40 | 50-60 | 60 |

*Performance varies by game and device specifications*

## CI/CD Integration

### GitHub Actions

The workflow file `.github/workflows/android-apk.yml` automatically:

1. Builds APKs on code changes
2. Runs on multiple triggers (push, PR, manual)
3. Uploads artifacts for download
4. Generates build summary

### Adding to Existing CI

```yaml
# Example GitLab CI integration
build-android:
  stage: build
  image: mcr.microsoft.com/dotnet/sdk:8.0
  script:
    - dotnet workload install android
    - dotnet publish src/BizHawk.Client.Android/BizHawk.Client.Android.csproj -c Release -f net8.0-android
  artifacts:
    paths:
      - apk-output/*.apk
```

## Next Steps

1. **Test on Real Devices**: Install and test APK on physical Android devices
2. **Implement UI**: Add touch controls and emulation interface
3. **Optimize Performance**: Profile and optimize emulation cores for mobile
4. **Add Features**: ROM browser, savestates, settings UI
5. **Public Release**: Sign APKs and prepare for distribution

## Resources

- [.NET Android Documentation](https://docs.microsoft.com/en-us/dotnet/maui/android/)
- [Android Developer Guide](https://developer.android.com/guide)
- [BizHawk Documentation](https://tasvideos.org/Bizhawk)
- [ARM64_MOBILE_SUPPORT.md](../ARM64_MOBILE_SUPPORT.md)

## Support

For issues or questions:
- Open an issue on GitHub
- Check existing documentation
- Review build logs in GitHub Actions

---

**Last Updated**: 2025-11-21  
**Maintained By**: Rafael Melo Reis  
**Project**: BizHawkRafaelia
